from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import Dict, Any, List, Optional
import httpx
import uvicorn
from datetime import datetime

app = FastAPI(title="Anypoint MCP Server")

# ==========================================================
# CORS SETTINGS
# ==========================================================
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],     # Allow all origins
    allow_credentials=True,
    allow_methods=["*"],     # Allow all HTTP methods
    allow_headers=["*"],     # Allow all headers
)

ANYPOINT_TOKEN_URL = "https://anypoint.mulesoft.com/accounts/api/v2/oauth2/token"


# ==========================================================
# REQUEST / RESPONSE MODELS
# ==========================================================
class ToolCallRequest(BaseModel):
    name: str
    arguments: Dict[str, Any]


class ToolResponse(BaseModel):
    content: List[Dict[str, Any]]
    isError: Optional[bool] = False


class GetTokenArgs(BaseModel):
    client_id: str
    client_secret: str


# ==========================================================
# TOOL IMPLEMENTATIONS
# ==========================================================
async def get_token(client_id: str, client_secret: str) -> Dict[str, Any]:
    """Get OAuth client-credentials token from Anypoint."""
    
    payload = {
        "grant_type": "client_credentials",
        "client_id": client_id,
        "client_secret": client_secret,
    }

    async with httpx.AsyncClient() as client:
        try:
            resp = await client.post(ANYPOINT_TOKEN_URL, data=payload)
            resp.raise_for_status()

            token_data = resp.json()

            return {
                "success": True,
                "access_token": token_data.get("access_token"),
                "token_type": token_data.get("token_type", "Bearer"),
                "expires_in": token_data.get("expires_in"),
                "raw_response": resp.text
            }

        except httpx.HTTPStatusError as exc:
            return {
                "success": False,
                "error": f"HTTP error {exc.response.status_code}",
                "detail": exc.response.text
            }

        except Exception as exc:
            return {"success": False, "error": str(exc)}


async def deploy_to_cloudhub(token: str, app_name: str, mule_version: str, region: str = "us-east-1"):
    """Simulated deployment function (stub)."""
    return {
        "success": True,
        "app_name": app_name,
        "status": "DEPLOYED",
        "region": region
    }


async def get_application_status(token: str, app_name: str, environment_id: str):
    """Simulated app status function (stub)."""
    return {
        "success": True,
        "app_name": app_name,
        "status": "RUNNING"
    }


# ==========================================================
# TOOL REGISTRY
# ==========================================================
TOOLS = {
    "get_token": {
        "name": "get_token",
        "description": "Get OAuth client token from Anypoint Platform",
        "inputSchema": {
            "type": "object",
            "properties": {
                "client_id": {"type": "string"},
                "client_secret": {"type": "string"},
            },
            "required": ["client_id", "client_secret"]
        },
        "handler": get_token
    },

    "deploy_to_cloudhub": {
        "name": "deploy_to_cloudhub",
        "description": "Deploy a Mule app to CloudHub",
        "inputSchema": {
            "type": "object",
            "properties": {
                "token": {"type": "string"},
                "app_name": {"type": "string"},
                "mule_version": {"type": "string"},
                "region": {"type": "string", "default": "us-east-1"},
            },
            "required": ["token", "app_name", "mule_version"]
        },
        "handler": deploy_to_cloudhub
    },

    "get_application_status": {
        "name": "get_application_status",
        "description": "Get CloudHub application status",
        "inputSchema": {
            "type": "object",
            "properties": {
                "token": {"type": "string"},
                "app_name": {"type": "string"},
                "environment_id": {"type": "string"},
            },
            "required": ["token", "app_name", "environment_id"]
        },
        "handler": get_application_status
    }
}


# ==========================================================
# API ENDPOINTS
# ==========================================================
@app.get("/")
async def root():
    return {
        "service": "Anypoint MCP Server",
        "version": "1.0.0",
        "tools_count": len(TOOLS),
        "endpoints": {
            "health": "/health",
            "list_tools": "/tools/list",
            "call_tool": "/tools/call"
        }
    }


@app.get("/health")
async def health_check():
    return {
        "status": "healthy",
        "timestamp": datetime.now().isoformat(),
        "service": "anypoint-mcp-server"
    }


@app.get("/tools/list")
async def list_tools():
    tools_list = []
    for name, tool in TOOLS.items():
        tools_list.append({
            "name": tool["name"],
            "description": tool["description"],
            "inputSchema": tool["inputSchema"]
        })
    return {"tools": tools_list}


@app.post("/tools/call")
async def call_tool(request: ToolCallRequest) -> ToolResponse:
    if request.name not in TOOLS:
        raise HTTPException(
            status_code=404,
            detail=f"Tool '{request.name}' not found",
        )

    tool = TOOLS[request.name]
    handler = tool["handler"]

    try:
        result = await handler(**request.arguments)

        return ToolResponse(
            content=[{"type": "text", "text": result}],
            isError=not result.get("success", True)
        )

    except TypeError as e:
        raise HTTPException(
            status_code=400,
            detail=f"Invalid arguments: {str(e)}"
        )

    except Exception as e:
        return ToolResponse(
            content=[{"type": "text", "text": f"Execution error: {str(e)}"}],
            isError=True
        )


# ==========================================================
# DIRECT ENDPOINT
# ==========================================================
@app.post("/anypoint/token")
async def get_anypoint_token(args: GetTokenArgs):
    result = await get_token(args.client_id, args.client_secret)
    if not result.get("success"):
        raise HTTPException(status_code=401, detail=result.get("error"))
    return result


# ==========================================================
# SERVER STARTUP
# ==========================================================
if __name__ == "__main__":
    print("Starting Anypoint MCP Server at http://0.0.0.0:8000")
    uvicorn.run(app, host="0.0.0.0", port=8000)
